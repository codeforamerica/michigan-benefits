#!/bin/bash
set -e

echo "Opening tracker to check for stories awaiting acceptance..."
open "https://www.pivotaltracker.com/n/projects/2123705"

read -p "Are there no stories in the accept/reject state? (y/N) " -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]];then
  echo "Great!"
else
  echo "Please test and run acceptance for those stories first!"
  exit 1
fi

echo "Diffing the code between staging and production..."
bin/release-diff
read -p "Looks ok? (y/N) " -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]];then
  echo "Great!"
else
  echo "Have a closer look and you can do this again later!"
  exit 1
fi

echo "Checking for buildpack changes between staging and production."
diff <(heroku buildpacks -r staging) <(heroku buildpacks -r production) && echo ""
read -p "Are these the same (ignoring order)? " -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]];then
  echo "Great!"
else
  echo "Make sure these are correct and get back at me."
  exit 1
fi

echo "Diffing ENV variables between staging and production."
diff <(heroku config -r staging) <(heroku config -r production) && echo ""
read -p "Are these config variables the same (ignoring their value) (y/N) " -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo "Great!"
else
  echo "We're bailing out!"
  exit 1;
fi

read -p "Ready to deploy to production? (y/N) " -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]]; then
  heroku pipelines:promote -a michigan-benefits-staging
  heroku run bin/rails one_offs:run_all -a michigan-benefits-production
  heroku ps:restart -a michigan-benefits-production
fi

echo "Success! Application deployed to Production!"
echo "Please do some testing on production! (use zip 12345 to send a fake fax)"
