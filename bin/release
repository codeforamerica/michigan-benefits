#!/bin/bash
set -e

echo "Opening tracker to check for stories awaiting acceptance..."
open "https://www.pivotaltracker.com/n/projects/2123705"

read -p "Are there no stories in the accept/reject state? (y/N) " -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]];then
  echo "Great!"
else
  echo "Please test and run acceptance for those stories first!"
  exit 1
fi

echo "Diffing the code between staging and production..."
bin/release-diff
read -p "Looks ok? (y/N) " -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]];then
  echo "Great!"
else
  echo "Have a closer look and you can do this again later!"
  exit 1
fi

echo "Checking for buildpack changes between staging and production."
diff <(heroku buildpacks -r staging) <(heroku buildpacks -r production) && echo ""
read -p "Are these the same (ignoring order)? (y/N)" -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]];then
  echo "Great!"
else
  echo "Make sure these are correct and get back at me."
  exit 1
fi

echo "Diffing ENV variables between staging and production."
staging_env=$(heroku config -r staging --json | jq -S 'keys')
production_env=$(heroku config -r production --json | jq -S 'keys')
echo ${staging_env[@]} ${production_env[@]} | tr ' ' '\n' | sort | uniq -u
echo "Any keys listed above exist on one env but not the other."
read -p "Are you okay with these differences? (y/N)" -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo "Great!"
else
  echo "We're bailing out!"
  exit 1;
fi

read -p "Ready to deploy to production? (y/N) " -n 1 -r
echo    # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]]; then
  heroku pipelines:promote -a michigan-benefits-pre-prod
  heroku run bin/rails one_offs:run_all -a michigan-benefits-production
  heroku ps:restart -a michigan-benefits-production
  echo "Success! Application deployed to Production!"
  echo "Please do some testing on production! (use zip 12345 to send a fake fax)"
else
  echo "Okay, I won't deploy. Thank you for being thoughtful and careful!"
  exit 1;
fi

