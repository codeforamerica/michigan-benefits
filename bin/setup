#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative 'bin_helpers'

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file.

  step 'Installing dependencies' do
    system! 'gem install bundler --conservative'
    system('bundle check') || system!('bundle install')
    system('which direnv') || system!('brew install direnv')
  end

  step 'Copying sample files' do
    ['.envrc'].each do |file|
      unless File.exist?(file)
        cp "#{file}.sample", file
        puts "Copied #{file}.sample to #{file}"
        system! "ln -s #{file} .env"
      end
    end
  end

  step 'Preparing database' do
    system! 'bin/rails db:setup'
  end

  step 'Removing old logs and tempfiles' do
    system! 'bin/rails log:clear tmp:clear'
  end

  step 'Restarting application server' do
    system! 'bin/rails restart'
  end
end
